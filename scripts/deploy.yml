- name: Bouillage
  hosts: bouillage
  vars:
    cabanasucre_service: bouillage
    cabanasucre_venv: /opt/cabanasucre_venv
    cabanasucre_version: 0.1.3
    packages:
      - build-essential
      - libssl-dev
      - libffi-dev
      - python3-dev
      - python3-pip
      - python3-venv
      - librdkafka-dev
  tasks:
    - name: Ensure w1-gpio overlay is present in /boot/config.txt
      ansible.builtin.lineinfile:
        path: /boot/config.txt
        line: dtoverlay=w1-gpio
        state: present
      notify: reboot

    - name: Ensure w1-therm kernel module is loaded at boot time
      ansible.builtin.lineinfile:
        path: /etc/modules
        line: w1-therm
        state: present
      notify: reboot

    - name: Load w1-gpio kernel module immediately (for current session)
      community.general.modprobe:
        name: w1-gpio
        state: present

    - name: Load w1-therm kernel module immediately (for current session)
      community.general.modprobe:
        name: w1-therm
        state: present

    - name: Installer les packages pré-requis
      ansible.builtin.apt:
        name: "{{ package }}"
        state: present
      loop: "{{ packages }}"
      loop_control:
        loop_var: package

    - name: Create Python virtual environment
      ansible.builtin.command:
        cmd: python3 -m venv {{ cabanasucre_venv }}
        creates: "{{ cabanasucre_venv }}/bin/activate"

    - name: Installer le module de bouillage
      ansible.builtin.pip:
        name: bouillage
        version: "{{ cabanasucre_version }}"
        virtualenv: "{{ cabanasucre_venv }}"
        state: present

    - name: Créer le fichier de service systemd
      template:
        src: templates/service.j2
        dest: /etc/systemd/system/{{ cabanasucre_service }}.service
        owner: root
        group: root
        mode: '0644'
      notify: reboot

    - name: Activer et démarrer le service
      systemd:
        name: "{{ cabanasucre_service }}.service"
        enabled: yes
        state: started
        daemon_reload: yes  # Important si le fichier a changé
      register: service_status

  handlers:
    - name: reboot
      ansible.builtin.reboot:
        reboot_timeout: 600
